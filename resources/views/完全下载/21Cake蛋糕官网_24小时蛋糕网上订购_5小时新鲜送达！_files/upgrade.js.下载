;(function($){
var FULL_SCREEN_UPGRADE=0;
var CHECK_SALE_CITY_TC=null;
function showUpgrade(data){
  var url=data.url;
  var dialog=$("#upgrade_dialog_outer");
  var dialog_inner=$("#upgrade_dialog_content");
  var cancel=$("#upgrade_cancel_web");
  var submit=$("#upgrade_submit_web");
  dialog.show();
  var resizeDialogPos=function(){
    var h=$(document).height();
    var wh=$(window).height();
    var dh=dialog_inner.height();
    dialog.css({
      "height":h  
    });
    if(wh > dh){
      dialog_inner.css({
        "top":0,
        "margin-top":(wh-dh)/2
      });
    }else{
      dialog_inner.css({
        "top":0,
        "margin-top":0
      })
    }
  }
  var resizeTc=null;
  var resizeWindow=function(){
    if(resizeTc){
      clearTimeout(resizeTc);
    }
    resizeTc=setTimeout(function(){
      resizeDialogPos();  
    },50);
  }
  $(window).bind("resize",resizeWindow)
  submit.attr("href",url);
  cancel.bind("click",function(){
    dialog.hide();
    $(window).unbind("resize",resizeWindow);
    setCookie('close_upgrade', 1,24*3600*1000 * 7);
  });
  submit.bind("click",function(){
    dialog.hide();
    $(window).unbind("resize",resizeWindow);
    setCookie('close_upgrade', 1,24*3600*1000 * 7);
  });
}
function check_sale_city(url,fn){
  var b = getCookie("sale_city");
  if( b.indexOf("first")===-1 ){
    CHECK_SALE_CITY_TC=setTimeout(function(){
      check_sale_city(url,fn);
    },100);
  }else{
    //check_is_old_member(url,fn);
  }
}
function check_is_old_member(url,callback){
  var b = getCookie("close_upgrade");
  if(!b){
    $.ajax({
      url:url,
      dataType:'json'
    }).always(function(data,str){
      if(callback){
        callback(data,str);
        return;
      }
      if(data.code===0){
         showUpgrade(data);
      }
    });
  }
}
function showFullScreenUpgrade(){
  var url="/member-index-fullscreenupgrade.html";
  var dialog=$("#upgrade_fullscreen");
  var cancel=$("#upgrade_fullscreen_close");
  var submit=$("#upgrade_fullscreen_submit");
  var img=new Image();
  img.onload=img.oncomplete=function(){
    dialog.slideDown();
  };
  img.src="/themes/21cake/images/big-member-img2.jpg";
  submit.attr("href",url).attr("target","_blank");
  cancel.bind("click",function(){
    dialog.slideUp();
    setCookie('close_upgrade', 1,24*3600*1000);
  });
  submit.bind("click",function(){
    dialog.hide();
    tongji("?fullscreenupgrade=1");
    setCookie('close_upgrade', 1,24*3600*1000);
  });
}
var tongji=(function(){
  var iframe=document.createElement("iframe");
  iframe.style.display="none";
  document.body.appendChild(iframe);
  return function(query){
    iframe.src="/passport.html"+query;
  }
})();
function checkUserType(data,str){
  if(str!='success' || data.code===0 || data.code===1){
    showFullScreenUpgrade(); 
  }
}
/*将就当入口*/
setTimeout(function(){
  var path=location.pathname;
  var upgrade_url = $('#upgrade_url').attr('upgrade_url');
  if(!FULL_SCREEN_UPGRADE){
    var except=["member","passport"];
    if(except && except.length){
      for(var i=0;i<except.length;i++){
        if( path.indexOf( except[i] )!==-1){
          return;
        }
      }
    }
    check_sale_city(upgrade_url); 
  }else{
    if(path==="/" || path==="" || path.indexOf("/index")===0){
      check_sale_city(upgrade_url,checkUserType); 
    }
  }
},10);
clearTimeout(CHECK_SALE_CITY_TC,6e5);
})(jQuery);
